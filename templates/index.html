<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—É–¥–µ–±–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Roboto Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #eef2f7;
            margin: 0;
            padding-bottom: 50px;
        }
        .nav {
            background: #1a237e;
            color: #fff;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #c5a059;
        }
        .nav a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            margin-left: 15px;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.85em;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea { resize: vertical; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn-send {
            background: #c5a059;
            color: white;
            padding: 15px;
            border: none;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-send:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .case-image {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 6px;
        }
        .badge-new { background: #e3f2fd; color: #1565c0; }
        .badge-court { background: #fff3cd; color: #856404; }

        /* Canvas –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PNG */
        #paper-canvas {
            position: absolute;
            left: -9999px;
            top: 0;
        }
    </style>
</head>
<body>

<div class="nav">
    <h2>‚öñÔ∏è –ö–ê–ù–¶–ï–õ–Ø–†–ò–Ø –°–£–î–ê</h2>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/logout">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="container">
    <!-- –§–û–†–ú–ê -->
    <div class="card">
        <h3 style="margin-top:0">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>

        <div class="form-grid">
            <div>
                <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–∞ (–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –°—É–¥–∞1):</label>
                <input type="text" id="f_court1" placeholder="–£–∫–∞–∑–∞—Ç—å —Å—É–¥">
            </div>
            <div>
                <label>–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê:</label>
                <input type="text" id="f_process" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –±—Ä–∞–∫–∞">
            </div>
        </div>

        <div class="form-grid">
            <div>
                <label>–ò—Å—Ç–µ—Ü ‚Äî –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ1:</label>
                <input type="text" id="f_fio1" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">
                <label>–ê–¥—Ä–µ—Å1:</label>
                <input type="text" id="f_addr1" placeholder="–ê–¥—Ä–µ—Å –∏—Å—Ç—Ü–∞">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω1:</label>
                <input type="text" id="f_tel1" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏—Å—Ç—Ü–∞">
            </div>
            <div>
                <label>–û—Ç–≤–µ—Ç—á–∏–∫ ‚Äî –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ2:</label>
                <input type="text" id="f_fio2" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">
                <label>–ê–¥—Ä–µ—Å2:</label>
                <input type="text" id="f_addr2" placeholder="–ê–¥—Ä–µ—Å –æ—Ç–≤–µ—Ç—á–∏–∫–∞">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω2:</label>
                <input type="text" id="f_tel2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–≤–µ—Ç—á–∏–∫–∞">
            </div>
        </div>

        <label>–°—É—Ç—å –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è (–¥–æ 950 —Å–∏–º–≤–æ–ª–æ–≤):</label>
        <textarea id="f_text" rows="6" placeholder="–û–ø–∏—à–∏—Ç–µ —Å—É—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è..."></textarea>
        <div id="text-counter" style="font-size:0.8em;color:#666;margin-top:4px;">
            0 / 950 —Å–∏–º–≤–æ–ª–æ–≤
        </div>

        <div class="form-grid">
            <div>
                <label>–ü–æ–¥–ø–∏—Å—å (–§–∞–º–∏–ª–∏—è –ò.–û.):</label>
                <input type="text" id="f_sign" placeholder="–§–∞–º–∏–ª–∏—è –ò.–û.">
            </div>
            <div>
                <label>–î–∞—Ç–∞:</label>
                <div style="display:flex;gap:6px;">
                    <input type="text" id="f_day"   placeholder="01" style="width:60px;">
                    <input type="text" id="f_month" placeholder="—è–Ω–≤–∞—Ä—è" style="flex:1;">
                    <input type="text" id="f_year"  placeholder="26" style="width:70px;">
                </div>
                <small style="color:#777;">–§–æ—Ä–º–∞—Ç: 01 —è–Ω–≤–∞—Ä—è 26</small>
            </div>
        </div>

        <button class="btn-send" onclick="generateAndSend()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)</button>
    </div>

    <!-- –°–ü–ò–°–û–ö –î–ï–õ -->
    <div class="card">
        <h3>üìÇ –î–µ–ª–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
        {% if cases %}
            {% for case in cases %}
                <div style="margin-bottom:20px;">
                    <p>
                        <strong>–î–µ–ª–æ {{ case.case_num }}</strong>
                        <span class="badge badge-court">{{ case.court_type }}</span>
                        <span class="badge badge-new">{{ case.status }}</span><br>
                        <small>–î–∞—Ç–∞: {{ case.date.strftime('%d.%m.%Y %H:%M') }} UTC</small>
                    </p>
                    <img src="{{ case.image_data }}" class="case-image">
                </div>
            {% endfor %}
        {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–ª.</p>
        {% endif %}
    </div>
</div>

<!-- Canvas, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∏—Å—É–µ–º —Ñ–æ–Ω + —Ç–µ–∫—Å—Ç -->
<canvas id="paper-canvas" width="795" height="1123"></canvas>

<script>
    const MAX_LEN = 950;
    const textArea = document.getElementById('f_text');
    const counter = document.getElementById('text-counter');

    textArea.addEventListener('input', e => {
        let v = e.target.value;
        if (v.length > MAX_LEN) {
            v = v.slice(0, MAX_LEN);
            e.target.value = v;
        }
        counter.textContent = `${v.length} / ${MAX_LEN} —Å–∏–º–≤–æ–ª–æ–≤`;
    });

    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ P1..P13
    const points = {
        court1: {x:449, y:91},   // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –°—É–¥–∞1 (P1)
        fio1:   {x:460, y:184},  // –§–ò–û1 (–∏—Å—Ç–µ—Ü) (P2)
        addr1:  {x:468, y:219},  // –ê–¥—Ä–µ—Å1 (P3)
        tel1:   {x:462, y:248},  // –¢–µ–ª–µ—Ñ–æ–Ω1 (P4)
        fio2:   {x:459, y:301},  // –§–ò–û2 (–æ—Ç–≤–µ—Ç—á–∏–∫) (P5)
        tel2:   {x:459, y:370},  // –¢–µ–ª–µ—Ñ–æ–Ω2 (P6)
        addr2:  {x:464, y:336},  // –ê–¥—Ä–µ—Å2 (P7)
        process:{x:285, y:441},  // –ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê (P8)
        sign:   {x:57,  y:985},  // –ø–æ–¥–ø–∏—Å—å (P9)
        signDec:{x:229, y:985},  // —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (P10)
        day:    {x:499, y:985},  // P11
        month:  {x:538, y:985},  // P12
        year:   {x:685, y:985}   // P13
    };

    // –§–æ–Ω
    const bgImage = new Image();
    bgImage.src = "/static/court_template.png"; // –ø–æ–ª–æ–∂–∏ PNG —Å—é–¥–∞

    function drawText(ctx, text, x, y, font, bold=false) {
        ctx.font = (bold ? 'bold ' : '') + font;
        ctx.fillStyle = "#000000";
        ctx.textBaseline = "top";
        ctx.fillText(text, x, y);
    }

    async function generateAndSend() {
        const btn = document.querySelector('.btn-send');
        btn.disabled = true;
        btn.textContent = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG...";

        const required = ['f_court1','f_fio1','f_fio2','f_text','f_sign','f_day','f_month','f_year'];
        for (const id of required) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                btn.disabled = false;
                btn.textContent = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
                return;
            }
        }

        await new Promise(resolve => {
            if (bgImage.complete) return resolve();
            bgImage.onload = resolve;
            bgImage.onerror = () => { alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω PNG"); resolve(); };
        });

        const canvas = document.getElementById('paper-canvas');
        const ctx = canvas.getContext('2d');

        // –û—á–∏—â–∞–µ–º –∏ —Ä–∏—Å—É–µ–º —Ñ–æ–Ω
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

        // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        const v = {
            court1: document.getElementById('f_court1').value,
            fio1:   document.getElementById('f_fio1').value,
            addr1:  document.getElementById('f_addr1').value,
            tel1:   document.getElementById('f_tel1').value,
            fio2:   document.getElementById('f_fio2').value,
            addr2:  document.getElementById('f_addr2').value,
            tel2:   document.getElementById('f_tel2').value,
            process:document.getElementById('f_process').value,
            text:   document.getElementById('f_text').value,
            sign:   document.getElementById('f_sign').value,
            day:    document.getElementById('f_day').value,
            month:  document.getElementById('f_month').value,
            year:   document.getElementById('f_year').value
        };

        // Roboto Serif 11 –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö, –∫—Ä–æ–º–µ –ø–æ–¥–ø–∏—Å–∏/–¥–∞—Ç—ã
        const mainFont = '11pt "Roboto Serif"';
        const tnFont   = '13pt "Times New Roman"';

        // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–∞
        drawText(ctx, v.court1, points.court1.x, points.court1.y, mainFont, false);

        // –ò—Å—Ç–µ—Ü (–§–ò–û1 –∂–∏—Ä–Ω—ã–π)
        drawText(ctx, v.fio1,  points.fio1.x,  points.fio1.y,  mainFont, true);
        // –ê–¥—Ä–µ—Å1, –¢–µ–ª–µ—Ñ–æ–Ω1 –æ–±—ã—á–Ω—ã–µ
        drawText(ctx, v.addr1, points.addr1.x, points.addr1.y, mainFont, false);
        drawText(ctx, v.tel1,  points.tel1.x,  points.tel1.y,  mainFont, false);

        // –û—Ç–≤–µ—Ç—á–∏–∫ (–§–ò–û2 –∂–∏—Ä–Ω—ã–π)
        drawText(ctx, v.fio2,  points.fio2.x,  points.fio2.y,  mainFont, true);
        // –¢–µ–ª–µ—Ñ–æ–Ω2, –ê–¥—Ä–µ—Å2 –æ–±—ã—á–Ω—ã–µ
        drawText(ctx, v.tel2,  points.tel2.x,  points.tel2.y,  mainFont, false);
        drawText(ctx, v.addr2, points.addr2.x, points.addr2.y, mainFont, false);

        // –ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê –∂–∏—Ä–Ω—ã–π
        drawText(ctx, v.process, points.process.x, points.process.y, mainFont, true);

        // –°—É—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è ‚Äî —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ä–∞–∑–º–µ—Ä, –Ω–æ –º–æ–∂–Ω–æ —Å–ª–µ–≥–∫–∞ –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å –±—É–∫–≤—ã
        // –£–ø—Ä–æ—â—ë–Ω–Ω–æ: —Ä–∏—Å—É–µ–º –æ–±—ã—á–Ω—ã–º Roboto Serif 11 (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä—è–º–æ ¬´handwritten¬ª, –Ω—É–∂–Ω–æ –¥—Ä—É–≥–æ–π —à—Ä–∏—Ñ—Ç),
        // –Ω–æ –ø–æ –∑–∞–¥–∞–Ω–∏—é –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–µ–ª—å–∑—è, –∞ —à—Ä–∏—Ñ—Ç –æ–±—â–∏–π —É–∫–∞–∑–∞–Ω Roboto Serif.
        // –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π.
        const maxWidth = 500; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏
        ctx.font = mainFont;
        ctx.fillStyle = "#000";
        ctx.textBaseline = "top";
        const textX = 110;    // –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∞–±–∑–∞—Ü–∞
        const textY = 470;
        const lineHeight = 18;

        const words = v.text.split(' ');
        let line = '';
        let y = textY;
        for (let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = ctx.measureText(testLine);
            const w = metrics.width;
            if (w > maxWidth && n > 0) {
                ctx.fillText(line, textX, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        if (line) ctx.fillText(line, textX, y);

        // –ü–æ–¥–ø–∏—Å—å –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: Times New Roman 13, –æ–±—ã—á–Ω—ã–π
        drawText(ctx, v.sign, points.sign.x,    points.sign.y,    tnFont, false);
        drawText(ctx, v.sign, points.signDec.x, points.signDec.y, tnFont, false);

        // –î–∞—Ç–∞: Times New Roman 13, –æ–±—ã—á–Ω—ã–π
        drawText(ctx, v.day,   points.day.x,   points.day.y,   tnFont, false);
        drawText(ctx, v.month, points.month.x, points.month.y, tnFont, false);
        drawText(ctx, v.year,  points.year.x,  points.year.y,  tnFont, false);

        const imageData = canvas.toDataURL("image/png");
        const courtType = v.court1 || "–í–µ—Ä—Ö–æ–≤–Ω—ã–π —Å—É–¥";

        try {
            const response = await fetch('/save_case_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageData,
                    court_type: courtType
                })
            });
            if (response.ok) {
                const res = await response.json();
                alert("–ò—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ù–æ–º–µ—Ä –¥–µ–ª–∞: " + res.case_num);
                location.reload();
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.");
                btn.disabled = false;
                btn.textContent = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.");
            btn.disabled = false;
            btn.textContent = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
        }
    }
</script>
</body>
</html>

