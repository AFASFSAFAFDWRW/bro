<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Канцелярия суда</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background:#eef2f7; margin:0; }
        .nav { background:#1a237e; color:#fff; padding:12px 40px; display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid #c5a059; }
        .nav a { color:#ffd700; text-decoration:none; font-weight:700; margin-left:14px; }
        .container { max-width:1100px; margin:20px auto; padding:0 12px; }
        .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; }
        .card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
        h2,h3{ margin:0 0 10px; }
        label { display:block; margin-top:10px; font-weight:700; font-size:.85em; color:#374151; }
        input, select { width:100%; padding:10px; margin-top:6px; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box; }
        .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .muted { color:#6b7280; font-size:.85em; }
        .btn { border:none; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:800; }
        .btn-primary { background:#c5a059; color:#fff; width:100%; margin-top:14px; }
        .btn-secondary { background:#e5e7eb; color:#111827; }
        .btn-danger { background:#dc2626; color:#fff; }
        .btn:disabled { opacity:.6; cursor:wait; }
        table { width:100%; border-collapse:collapse; font-size:.92em; }
        th, td { border-bottom:1px solid #e5e7eb; padding:8px 6px; text-align:left; vertical-align:top; }
        th { background:#f8fafc; }
        .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.78em; margin-left:6px; background:#eef2ff; color:#3730a3; }
        .tag2 { background:#ecfeff; color:#155e75; }
        .tag3 { background:#fff7ed; color:#9a3412; }
        .actions { display:flex; gap:8px; flex-wrap:wrap; }

        #paper-canvas { position:absolute; left:-9999px; top:0; }
        #previewWrap { display:none; margin-top:12px; }
        #previewImg { width:100%; border:1px solid #e5e7eb; border-radius:10px; }
    </style>
</head>
<body>
<div class="nav">
    <div><strong>⚖ КАНЦЕЛЯРИЯ СУДА</strong></div>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/admin">Панель ПВС</a>
        <a href="/logout">Выйти</a>
    </div>
</div>

<div class="container">
    <div class="grid">
        <!-- FORM -->
        <div class="card">
            <h3>Заполнение искового заявления</h3>
            <div class="muted">Автосохранение черновика включено. PNG создаётся по шаблону.</div>

            <label>Наименование суда</label>
            <select id="f_court1">
                <option value="" selected disabled>Выберите суд</option>
                <option>Верховный Суд</option>
                <option>Кассационный Суд</option>
                <option>Суд по Уголовным делам</option>
                <option>Суд по Административным делам</option>
                <option>Суд по гражданским делам</option>
            </select>

            <label>Наименование процесса</label>
            <select id="f_process">
                <option value="" selected disabled>Выберите тип иска</option>
                <option disabled>1. Семейные споры</option>
                <option>расторжение брака (развод)</option>
                <option>признание брака недействительным</option>
                <option>взыскание алиментов (на детей, нетрудоспособного супруга, родителей)</option>
                <option>установление отцовства</option>
                <option>оспаривание отцовства (материнства)</option>
                <option>лишение родительских прав</option>
                <option>ограничение родительских прав</option>
                <option>определение места жительства ребенка</option>
                <option>определение порядка общения с ребенком (порядок встреч)</option>
                <option>устранение препятствий к общению с ребенком</option>
                <option>раздел совместно нажитого имущества супругов</option>
                <option>взыскание неустойки по алиментам</option>

                <option disabled>2. Жилищные споры</option>
                <option>признание права пользования жилым помещением</option>
                <option>вселение</option>
                <option>выселение</option>
                <option>устранение препятствий в пользовании имуществом</option>
                <option>признание утратившим право пользования жилым помещением</option>
                <option>определение порядка пользования жилым помещением</option>
                <option>перевод прав и обязанностей по договору найма</option>
                <option>приватизация жилого помещения</option>
                <option>признание обмена жилыми помещениями недействительным</option>
            </select>

            <div class="row">
                <div>
                    <label>Истец (ФИО)</label>
                    <input id="f_fio1" placeholder="Фамилия Имя Отчество">
                    <label>Адрес истца</label>
                    <input id="f_addr1" placeholder="Адрес">
                    <label>Телефон истца</label>
                    <input id="f_tel1" placeholder="Телефон">
                </div>
                <div>
                    <label>Ответчик (ФИО)</label>
                    <input id="f_fio2" placeholder="Фамилия Имя Отчество">
                    <label>Адрес ответчика</label>
                    <input id="f_addr2" placeholder="Адрес">
                    <label>Телефон ответчика</label>
                    <input id="f_tel2" placeholder="Телефон">
                </div>
            </div>

            <label>Суть (3 строки)</label>
            <input id="f_line1" placeholder="Строка 1 (до 80 символов)" maxlength="80">
            <input id="f_line2" placeholder="Строка 2 (до 80 символов)" maxlength="80">
            <input id="f_line3" placeholder="Строка 3 (до 80 символов)" maxlength="80">

            <div class="row">
                <div>
                    <label>Подпись (Фамилия И.О.)</label>
                    <input id="f_sign" placeholder="Фамилия И.О.">
                </div>
                <div>
                    <label>Дата</label>
                    <div class="row" style="grid-template-columns:80px 1fr 80px;">
                        <input id="f_day" placeholder="01" maxlength="2">
                        <input id="f_month" placeholder="января">
                        <input id="f_year" placeholder="26" maxlength="2">
                    </div>
                    <div class="muted">Формат: 01 января 26</div>
                </div>
            </div>

            <div class="actions" style="margin-top:12px;">
                <button class="btn btn-secondary" onclick="previewPNG()">Предпросмотр</button>
                <button class="btn btn-danger" onclick="clearDraft()">Очистить</button>
            </div>

            <button class="btn btn-primary" onclick="generateAndSend()">СФОРМИРОВАТЬ И ОТПРАВИТЬ ИСК (PNG)</button>

            <div id="previewWrap">
                <h3 style="margin-top:14px;">Предпросмотр PNG</h3>
                <img id="previewImg" alt="preview">
            </div>
        </div>

        <!-- REGISTRY -->
        <div class="card">
            <h3>Реестр дел</h3>
            <div class="muted">Кликни «Открыть» чтобы увидеть дело и (если есть права) управлять статусом/решением.</div>

            <label>Фильтр</label>
            <input id="filterInput" placeholder="Поиск по номеру дела / статусу / суду" oninput="applyFilter()">

            <div style="overflow:auto; margin-top:10px; max-height:760px;">
                <table id="casesTable">
                    <thead>
                    <tr>
                        <th>Дело</th>
                        <th>Суд</th>
                        <th>Статус</th>
                        <th>Дата</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for case in cases %}
                    <tr>
                        <td><strong class="cnum">{{ case.case_num }}</strong></td>
                        <td class="ccourt">{{ case.court_type }}</td>
                        <td class="cstatus">{{ case.status }}</td>
                        <td>{{ case.date.strftime('%d.%m.%Y %H:%M') }} UTC</td>
                        <td><a href="/case/{{ case.case_num }}">Открыть</a></td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if not cases %}
            <p class="muted" style="margin-top:10px;">Пока нет доступных дел.</p>
            {% endif %}
        </div>
    </div>
</div>

<canvas id="paper-canvas" width="795" height="1123"></canvas>

<script>
    const CSRF = "{{ csrf }}";

    // AUTOSAVE DRAFT
    const draftKeys = [
        'f_court1','f_process','f_fio1','f_addr1','f_tel1','f_fio2','f_addr2','f_tel2',
        'f_line1','f_line2','f_line3','f_sign','f_day','f_month','f_year'
    ];

    function loadDraft(){
        draftKeys.forEach(id=>{
            const v = localStorage.getItem('draft_'+id);
            if(v !== null){
                const el = document.getElementById(id);
                if(el) el.value = v;
            }
        });
    }
    function saveDraft(){
        draftKeys.forEach(id=>{
            const el = document.getElementById(id);
            if(el) localStorage.setItem('draft_'+id, el.value || '');
        });
    }
    function clearDraft(){
        draftKeys.forEach(id=>localStorage.removeItem('draft_'+id));
        location.reload();
    }
    draftKeys.forEach(id=>{
        document.addEventListener('input', (e)=>{
            if(e.target && e.target.id === id) saveDraft();
        });
    });
    loadDraft();

    // FILTER
    function applyFilter(){
        const q = (document.getElementById('filterInput').value || '').toLowerCase();
        document.querySelectorAll('#casesTable tbody tr').forEach(tr=>{
            const cnum = tr.querySelector('.cnum')?.innerText.toLowerCase() || '';
            const ccourt = tr.querySelector('.ccourt')?.innerText.toLowerCase() || '';
            const cstatus = tr.querySelector('.cstatus')?.innerText.toLowerCase() || '';
            tr.style.display = (cnum.includes(q) || ccourt.includes(q) || cstatus.includes(q)) ? '' : 'none';
        });
    }

    // ---- CANVAS TEMPLATE COORDS (под твой PNG) ----
    const points = {
        court1: {x:430, y:95},
        fio1:   {x:455, y:185},
        addr1:  {x:455, y:218},
        tel1:   {x:455, y:251},
        fio2:   {x:455, y:313},
        addr2:  {x:455, y:346},
        tel2:   {x:455, y:379},
        process:{x:305, y:445},
        line1:  {x:105, y:520},
        line2:  {x:105, y:545},
        line3:  {x:105, y:570},
        sign:   {x:105, y:968},
        day:    {x:515, y:968},
        month:  {x:560, y:968},
        year:   {x:698, y:968}
    };

    const bgImage = new Image();
    bgImage.src = "/static/court_template.png";

    function drawText(ctx, text, x, y, font, bold=false) {
        ctx.font = (bold ? 'bold ' : '') + font;
        ctx.fillStyle = "#000000";
        ctx.textBaseline = "top";
        ctx.fillText(text, x, y);
    }

    async function ensureBg(){
        await new Promise(resolve=>{
            if(bgImage.complete) return resolve();
            bgImage.onload = resolve;
            bgImage.onerror = resolve;
        });
    }

    function getFormValues(){
        return {
            court1: document.getElementById('f_court1').value,
            process:document.getElementById('f_process').value,
            fio1: document.getElementById('f_fio1').value,
            addr1:document.getElementById('f_addr1').value,
            tel1: document.getElementById('f_tel1').value,
            fio2: document.getElementById('f_fio2').value,
            addr2:document.getElementById('f_addr2').value,
            tel2: document.getElementById('f_tel2').value,
            line1:document.getElementById('f_line1').value,
            line2:document.getElementById('f_line2').value,
            line3:document.getElementById('f_line3').value,
            sign: document.getElementById('f_sign').value,
            day: document.getElementById('f_day').value,
            month: document.getElementById('f_month').value,
            year: document.getElementById('f_year').value
        }
    }

    function validate(v){
        const required = ['court1','process','fio1','fio2','sign','day','month','year'];
        for(const k of required){
            if(!v[k] || !v[k].trim()) return false;
        }
        return true;
    }

    async function renderPNG(){
        await ensureBg();
        const canvas = document.getElementById('paper-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(bgImage,0,0,canvas.width,canvas.height);

        const v = getFormValues();
        const mainFont = '11pt "Roboto Serif"';
        const tnFont = '13pt "Times New Roman"';

        drawText(ctx, v.court1, points.court1.x, points.court1.y, mainFont, false);

        drawText(ctx, v.fio1, points.fio1.x, points.fio1.y, mainFont, true);
        drawText(ctx, v.addr1,points.addr1.x,points.addr1.y,mainFont,false);
        drawText(ctx, v.tel1, points.tel1.x, points.tel1.y, mainFont, false);

        drawText(ctx, v.fio2, points.fio2.x, points.fio2.y, mainFont, true);
        drawText(ctx, v.addr2,points.addr2.x,points.addr2.y,mainFont,false);
        drawText(ctx, v.tel2, points.tel2.x, points.tel2.y, mainFont, false);

        drawText(ctx, v.process, points.process.x, points.process.y, mainFont, true);

        if(v.line1) drawText(ctx, v.line1, points.line1.x, points.line1.y, mainFont, false);
        if(v.line2) drawText(ctx, v.line2, points.line2.x, points.line2.y, mainFont, false);
        if(v.line3) drawText(ctx, v.line3, points.line3.x, points.line3.y, mainFont, false);

        drawText(ctx, v.sign, points.sign.x, points.sign.y, tnFont, false);
        drawText(ctx, v.day, points.day.x, points.day.y, tnFont, false);
        drawText(ctx, v.month, points.month.x, points.month.y, tnFont, false);
        drawText(ctx, v.year, points.year.x, points.year.y, tnFont, false);

        return canvas.toDataURL("image/png");
    }

    async function previewPNG(){
        const v = getFormValues();
        if(!validate(v)){
            alert("Заполни обязательные поля: суд, процесс, ФИО, подпись и дату.");
            return;
        }
        const img = await renderPNG();
        document.getElementById('previewImg').src = img;
        document.getElementById('previewWrap').style.display = 'block';
        window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    }

    async function generateAndSend(){
        const btn = document.querySelector('.btn-primary');
        const v = getFormValues();
        if(!validate(v)){
            alert("Заполни обязательные поля: суд, процесс, ФИО, подпись и дату.");
            return;
        }
        btn.disabled = true;
        btn.textContent = "Отправка...";

        const imageData = await renderPNG();

        try{
            const resp = await fetch('/save_case_image', {
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-CSRF': CSRF
                },
                body: JSON.stringify({
                    image: imageData,
                    court_type: v.court1
                })
            });
            const data = await resp.json();
            if(resp.ok && data.status === 'success'){
                alert("Иск отправлен. Номер: " + data.case_num);
                localStorage.clear();
                location.reload();
            }else{
                alert("Ошибка: " + (data.message || 'unknown'));
                btn.disabled = false;
                btn.textContent = "СФОРМИРОВАТЬ И ОТПРАВИТЬ ИСК (PNG)";
            }
        }catch(e){
            console.error(e);
            alert("Ошибка сети");
            btn.disabled = false;
            btn.textContent = "СФОРМИРОВАТЬ И ОТПРАВИТЬ ИСК (PNG)";
        }
    }
</script>
</body>
</html>
