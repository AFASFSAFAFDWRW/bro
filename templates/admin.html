<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель ПВС | Судебная система</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #eef2f7;
        }
        .nav {
            background: #1a237e;
            color: #fff;
            padding: 12px 40px;
            display: flex;
            justify-content: space_between;
            align-items: center;
            border-bottom: 4px solid #c5a059;
        }
        .nav a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            margin-left: 15px;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
        }
        h2 { margin: 10px 0 20px; }
        .columns {
            display: grid;
            grid-template-columns: 2fr 1.1fr;
            gap: 20px;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th, td {
            border-bottom: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: left;
        }
        th {
            background: #f1f5f9;
            font-weight: 600;
        }
        tr:hover td {
            background: #f9fafb;
        }
        select, button, input[type="checkbox"] {
            font-family: inherit;
            font-size: 0.9em;
        }
        .btn {
            padding: 6px 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: #2563eb;
            color: #fff;
        }
        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        .badge-role {
            display: inline-block;
            padding: 2px 6px;
            margin: 1px;
            border-radius: 4px;
            background: #e5e7eb;
            font-size: 0.75em;
        }
        .member-selected {
            background: #dbeafe !important;
        }
        .muted { color:#6b7280; font-size:0.8em; }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 10px;
        }
        .tab {
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.9em;
        }
        .tab.active {
            border-bottom-color: #2563eb;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="nav">
    <div>
        <strong>⚖️ Панель ПВС</strong>
    </div>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/">К делам</a>
        <a href="/logout">Выйти</a>
    </div>
</div>

<div class="container">
    <h2>Управление участниками и ролями Discord</h2>
    <p class="muted">
        Обновление участников каждые 5 секунд.  
        Вкладка «Роли» — выдача/снятие ролей.  
        Вкладка «Права ролей» — виртуальные права на сайте (не трогают права в самом Discord).
    </p>

    <div class="columns">
        <!-- УЧАСТНИКИ -->
        <div class="card">
            <h3>Участники сервера</h3>
            <table id="membersTable">
                <thead>
                <tr>
                    <th>Пользователь</th>
                    <th>Роли</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- ПРАВА/РОЛИ -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" data-tab="roles">Роли</div>
                <div class="tab" data-tab="perms">Права ролей</div>
            </div>

            <!-- ТАБ РОЛИ -->
            <div class="tab-content active" id="tab-roles">
                <h3>Выдача / снятие ролей</h3>
                <p class="muted">
                    Выберите участника слева, затем роль и действие.
                </p>
                <div>
                    <label>Выбранный участник:</label>
                    <div id="selectedMember" class="muted">не выбран</div>
                </div>
                <div style="margin-top:10px;">
                    <label>Роль:</label>
                    <select id="roleSelect" style="width:100%;"></select>
                </div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                    <button class="btn btn-primary" onclick="changeRole('add')">Выдать роль</button>
                    <button class="btn btn-danger" onclick="changeRole('remove')">Снять роль</button>
                </div>
            </div>

            <!-- ТАБ ПРАВА -->
            <div class="tab-content" id="tab-perms">
                <h3>Виртуальные права ролей (на сайте)</h3>
                <p class="muted">
                    Здесь настраиваются только права внутри веб‑сайта.
                </p>
                <div>
                    <label>Роль:</label>
                    <select id="permRoleSelect" style="width:100%;"></select>
                </div>
                <div style="margin-top:10px;">
                    <label><input type="checkbox" id="perm_close"> Может закрывать дела</label><br>
                    <label><input type="checkbox" id="perm_view_all"> Видит все дела</label><br>
                    <label><input type="checkbox" id="perm_create" checked> Может создавать иски</label>
                </div>
                <button class="btn btn-primary" style="margin-top:12px;" onclick="savePermissions()">
                    Сохранить права роли
                </button>
                <p id="permStatus" class="muted" style="margin-top:6px;"></p>
            </div>
        </div>
    </div>
</div>

<canvas id="dummy" style="display:none;"></canvas>

<script>
    let members = [];
    let roles = [];
    let selectedMemberId = null;

    // ---------- вкладки ----------
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
    });

    // ---------- участники ----------
    async function fetchMembers() {
        try {
            const resp = await fetch('/api/members');
            if (!resp.ok) return;
            members = await resp.json();
            renderMembers();
        } catch (e) {
            console.error('members error', e);
        }
    }

    function renderMembers() {
        const tbody = document.querySelector('#membersTable tbody');
        tbody.innerHTML = '';
        members.forEach(m => {
            const tr = document.createElement('tr');
            tr.dataset.id = m.discord_id;
            if (m.discord_id === selectedMemberId) tr.classList.add('member-selected');

            tr.onclick = () => {
                selectedMemberId = m.discord_id;
                document.querySelectorAll('#membersTable tbody tr')
                    .forEach(row => row.classList.remove('member-selected'));
                tr.classList.add('member-selected');
                document.getElementById('selectedMember').innerText =
                    `${m.username} (${m.discord_id})`;
            };

            const tdName = document.createElement('td');
            tdName.textContent = m.username;

            const tdRoles = document.createElement('td');
            if (m.roles && m.roles.length) {
                m.roles.forEach(r => {
                    if (!r) return;
                    const span = document.createElement('span');
                    span.className = 'badge-role';
                    span.textContent = r;
                    tdRoles.appendChild(span);
                });
            } else {
                tdRoles.innerHTML = '<span class="muted">нет ролей</span>';
            }

            tr.appendChild(tdName);
            tr.appendChild(tdRoles);
            tbody.appendChild(tr);
        });
    }

    // ---------- роли + права ----------
    async function fetchRoles() {
        try {
            const resp = await fetch('/api/roles');
            if (!resp.ok) return;
            roles = await resp.json();
            renderRoleSelects();
        } catch (e) {
            console.error('roles error', e);
        }
    }

    function renderRoleSelects() {
        const roleSel = document.getElementById('roleSelect');
        const permRoleSel = document.getElementById('permRoleSelect');
        roleSel.innerHTML = '';
        permRoleSel.innerHTML = '';

        roles.forEach(r => {
            const opt1 = document.createElement('option');
            opt1.value = r.id;
            opt1.textContent = r.name;
            roleSel.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = r.id;
            opt2.textContent = r.name;
            opt2.dataset.close = r.can_close_cases ? '1' : '0';
            opt2.dataset.viewall = r.can_view_all_cases ? '1' : '0';
            opt2.dataset.create = r.can_create_cases ? '1' : '0';
            permRoleSel.appendChild(opt2);
        });

        updatePermCheckboxes();
        permRoleSel.onchange = updatePermCheckboxes;
    }

    function updatePermCheckboxes() {
        const sel = document.getElementById('permRoleSelect');
        const opt = sel.options[sel.selectedIndex];
        if (!opt) return;
        document.getElementById('perm_close').checked = opt.dataset.close === '1';
        document.getElementById('perm_view_all').checked = opt.dataset.viewall === '1';
        document.getElementById('perm_create').checked = opt.dataset.create !== '0';
        document.getElementById('permStatus').textContent = '';
    }

    async function changeRole(action) {
        if (!selectedMemberId) {
            alert('Выберите участника в таблице слева.');
            return;
        }
        const roleId = document.getElementById('roleSelect').value;
        if (!roleId) {
            alert('Выберите роль.');
            return;
        }

        try {
            const resp = await fetch('/api/set_role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    discord_id: selectedMemberId,
                    role_id: roleId,
                    action: action
                })
            });
            const data = await resp.json();
            if (data.result === 'ok') {
                await fetchMembers();
            } else {
                alert('Ошибка операции: ' + data.result);
            }
        } catch (e) {
            console.error(e);
            alert('Ошибка сети при изменении роли.');
        }
    }

    async function savePermissions() {
        const sel = document.getElementById('permRoleSelect');
        const opt = sel.options[sel.selectedIndex];
        if (!opt) {
            alert('Нет роли.');
            return;
        }
        const roleId = opt.value;
        const roleName = opt.textContent;

        const body = {
            role_id: roleId,
            role_name: roleName,
            can_close_cases: document.getElementById('perm_close').checked,
            can_view_all_cases: document.getElementById('perm_view_all').checked,
            can_create_cases: document.getElementById('perm_create').checked
        };

        try {
            const resp = await fetch('/api/role_permissions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (data.result === 'ok') {
                document.getElementById('permStatus').textContent = 'Права сохранены';
                // обновим roles, чтобы локальные данные совпали
                await fetchRoles();
            } else {
                document.getElementById('permStatus').textContent = 'Ошибка сохранения';
            }
        } catch (e) {
            console.error(e);
            document.getElementById('permStatus').textContent = 'Ошибка сети';
        }
    }

    // начальная загрузка
    fetchMembers();
    fetchRoles();
    setInterval(fetchMembers, 5000); // автообновление участников
</script>
</body>
</html>
