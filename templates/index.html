<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—É–¥–µ–±–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #eef2f7;
            margin: 0;
            padding-bottom: 50px;
        }
        .nav {
            background: #1a237e;
            color: #fff;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #c5a059;
        }
        .nav a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            margin-left: 15px;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.85em;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn-send {
            background: #c5a059;
            color: white;
            padding: 15px;
            border: none;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-send:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        #paper-template {
            width: 794px;
            height: 1123px;
            padding: 60px 80px;
            background: white;
            position: absolute;
            left: -9999px;
            top: 0;
            box-sizing: border-box;
            color: black;
            line-height: 1.3;
        }
        .a4-header {
            margin-left: auto;
            width: 60%;
            text-align: right;
        }
        .a4-header p {
            margin: 2px 0;
            font-size: 14pt;
            font-family: "Times New Roman", serif;
        }
        .line-under {
            border-bottom: 1px solid black;
            display: inline-block;
            width: 100%;
            min-height: 20px;
            text-align: center;
            font-weight: bold;
        }
        .small-hint {
            font-size: 8pt;
            display: block;
            text-align: center;
            margin-top: -2px;
        }
        .a4-title {
            text-align: center;
            margin-top: 50px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .a4-content {
            margin-top: 30px;
            text-indent: 40px;
            font-size: 13pt;
            min-height: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .a4-footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .case-image {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 6px;
        }
        .badge-new { background: #e3f2fd; color: #1565c0; }
        .badge-court { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div class="nav">
    <h2>‚öñÔ∏è –ö–ê–ù–¶–ï–õ–Ø–†–ò–Ø –°–£–î–ê</h2>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/logout">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <h3 style="margin-top:0">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>

        <div class="form-grid">
            <div>
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–¥:</label>
                <select id="f_court">
                    {% for c in court_options %}
                        <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>–¢–∏–ø –ø—Ä–æ—Ü–µ—Å—Å–∞:</label>
                <select id="f_type">
                    <optgroup label="1. –°–µ–º–µ–π–Ω—ã–µ —Å–ø–æ—Ä—ã">
                        <option>–ò—Å–∫ –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –±—Ä–∞–∫–∞ (—Ä–∞–∑–≤–æ–¥)</option>
                        <option>–ò—Å–∫ –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –∞–ª–∏–º–µ–Ω—Ç–æ–≤</option>
                    </optgroup>
                    <optgroup label="2. –ñ–∏–ª–∏—â–Ω—ã–µ —Å–ø–æ—Ä—ã">
                        <option>–ò—Å–∫ –æ –≤—Å–µ–ª–µ–Ω–∏–∏</option>
                        <option>–ò—Å–∫ –æ –≤—ã—Å–µ–ª–µ–Ω–∏–∏</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="form-grid">
            <div>
                <label>–§–ò–û –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">

                <label>–ê–¥—Ä–µ—Å –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec_addr" placeholder="–≥. –õ–æ—Å-–°–∞–Ω—Ç–æ—Å, —É–ª. –õ–µ–Ω–∏–Ω–∞">

                <label>–¢–µ–ª–µ—Ñ–æ–Ω –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec_phone" placeholder="777-888">
            </div>
            <div>
                <label>–§–ò–û –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü.">

                <label>–ê–¥—Ä–µ—Å –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet_addr" placeholder="–≥. –õ–æ—Å-–°–∞–Ω—Ç–æ—Å, —É–ª. –ú–∏—Ä–∞">

                <label>–¢–µ–ª–µ—Ñ–æ–Ω –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet_phone" placeholder="555-444">
            </div>
        </div>

        <label>–°—É—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è:</label>
        <textarea id="f_text" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é..."></textarea>

        <label>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å—å (–§–∞–º–∏–ª–∏—è –ò.–û.):</label>
        <input type="text" id="f_sign" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">

        <button class="btn-send" onclick="generateAndSend()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)</button>
    </div>

    <div id="casesList">
        <h3>üìÇ –î–µ–ª–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
        {% if cases %}
            {% for case in cases %}
                <div class="card">
                    <p>
                        <strong>–î–µ–ª–æ {{ case.case_num }}</strong>
                        <span class="badge badge-court">{{ case.court_type }}</span>
                        <span class="badge badge-new">{{ case.status }}</span><br>
                        <small>–î–∞—Ç–∞: {{ case.date.strftime('%d.%m.%Y %H:%M') }} UTC</small>
                    </p>
                    <img src="{{ case.image_data }}" class="case-image">
                </div>
            {% endfor %}
        {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–ª.</p>
        {% endif %}
    </div>
</div>

<!-- –®–ê–ë–õ–û–ù A4 –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò PNG -->
<div id="paper-template">
    <div class="a4-header">
        <p>–í <span id="p_court" class="line-under"></span></p>
        <span class="small-hint">(–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–µ–±–Ω–æ–π –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏)</span>
        <div style="margin-top:20px">
            <p>–ò—Å—Ç–µ—Ü: <span id="p_istec" class="line-under"></span></p>
            <p>–ê–¥—Ä–µ—Å: <span id="p_istec_addr" class="line-under"></span></p>
            <p>–¢–µ–ª–µ—Ñ–æ–Ω: <span id="p_istec_phone" class="line-under"></span></p>
        </div>
        <div style="margin-top:20px">
            <p>–û—Ç–≤–µ—Ç—á–∏–∫: <span id="p_otvet" class="line-under"></span></p>
            <p>–ê–¥—Ä–µ—Å: <span id="p_otvet_addr" class="line-under"></span></p>
            <p>–¢–µ–ª–µ—Ñ–æ–Ω: <span id="p_otvet_phone" class="line-under"></span></p>
        </div>
    </div>

    <div class="a4-title">
        –ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ<br>–æ <span id="p_type"></span>
    </div>

    <div class="a4-content" id="p_text"></div>

    <p style="font-size: 11pt; margin-top: 40px;">
        –ù–∞ –∑–∞–∫–æ–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö –ø—Ä–æ—à—É –°—É–¥ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ.
    </p>

    <div class="a4-footer">
        <div style="width: 200px; text-align: center;">
            <div style="border-bottom: 1px solid black; min-height: 30px;"></div>
            <span class="small-hint">( –ø–æ–¥–ø–∏—Å—å )</span>
        </div>
        <div style="width: 200px; text-align: center;">
            <div id="p_sign" style="border-bottom: 1px solid black; min-height: 30px; font-weight: bold;"></div>
            <span class="small-hint">( —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ )</span>
        </div>
        <div>
            ¬´<span id="p_day"></span>¬ª <span id="p_month"></span> 2026 –≥.
        </div>
    </div>
</div>

<script>
    // –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –∫ —à–∞–±–ª–æ–Ω—É A4
    const fields = [
        'court','istec','istec_addr','istec_phone',
        'otvet','otvet_addr','otvet_phone','type','text','sign'
    ];

    fields.forEach(f => {
        const inputEl = document.getElementById('f_' + f);
        if (!inputEl) return;

        inputEl.addEventListener('input', (e) => {
            const target = document.getElementById('p_' + f);
            if (target) target.innerText = e.target.value;
        });
    });

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å—É–¥ –∏ —Ç–∏–ø
    document.getElementById('p_court').innerText = document.getElementById('f_court').value;
    document.getElementById('p_type').innerText = document.getElementById('f_type').value;

    document.getElementById('f_court').addEventListener('change', (e) => {
        document.getElementById('p_court').innerText = e.target.value;
    });

    document.getElementById('f_type').addEventListener('change', (e) => {
        document.getElementById('p_type').innerText = e.target.value;
    });

    async function generateAndSend() {
        const btn = document.querySelector('.btn-send');
        btn.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG...";
        btn.disabled = true;

        // –ù–µ–º–Ω–æ–≥–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        const requiredIds = ['f_court','f_istec','f_otvet','f_text','f_sign'];
        for (const id of requiredIds) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
                return;
            }
        }

        const now = new Date();
        document.getElementById('p_day').innerText = now.getDate();
        const months = [
            "—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è",
            "–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"
        ];
        document.getElementById('p_month').innerText = months[now.getMonth()];

        const template = document.getElementById('paper-template');
        const canvas = await html2canvas(template, { scale: 2 });
        const imageData = canvas.toDataURL("image/png");

        const courtType = document.getElementById('f_court').value;

        try {
            const response = await fetch('/save_case_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageData,
                    court_type: courtType
                })
            });

            if (response.ok) {
                const res = await response.json();
                alert("–ò—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ù–æ–º–µ—Ä –¥–µ–ª–∞: " + res.case_num);
                location.reload();
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
            btn.disabled = false;
            btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
        }
    }
</script>
</body>
</html>
