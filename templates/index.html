<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—É–¥–µ–±–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #eef2f7;
            margin: 0;
            padding-bottom: 50px;
        }
        .nav {
            background: #1a237e;
            color: #fff;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #c5a059;
        }
        .nav a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            margin-left: 15px;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.85em;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn-send {
            background: #c5a059;
            color: white;
            padding: 15px;
            border: none;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-send:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .case-image {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 6px;
        }
        .badge-new { background: #e3f2fd; color: #1565c0; }
        .badge-court { background: #fff3cd; color: #856404; }

        /* ---- –û–§–û–†–ú–õ–ï–ù–ò–ï A4, –∫–∞–∫ –Ω–∞ –≤—Ç–æ—Ä–æ–º —Å–∫—Ä–∏–Ω–µ ---- */
        #paper-template {
            width: 794px;              /* A4 –ø—Ä–∏ 96 dpi */
            height: 1123px;
            padding: 60px;
            background: #ffffff;
            position: absolute;
            left: -9999px;
            top: 0;
            box-sizing: border-box;
            color: #000;
            font-family: "Times New Roman", serif;
            font-size: 12pt;
        }
        .a4-top {
            display: flex;
            justify-content: flex-end;
        }
        .a4-top-right {
            width: 60%;
            text-align: right;
        }
        .a4-court-line {
            border-bottom: 1px solid #000;
            display: inline-block;
            min-width: 250px;
            text-align: center;
            font-weight: bold;
        }
        .a4-label {
            font-weight: bold;
        }
        .a4-underline {
            border-bottom: 1px solid #000;
            min-width: 250px;
            display: inline-block;
            text-align: left;
            padding: 0 3px;
        }
        .a4-row {
            margin-top: 8px;
        }
        .a4-title-block {
            text-align: center;
            margin-top: 60px;
            font-weight: bold;
            text-transform: none;
        }
        .a4-title-main {
            font-size: 14pt;
        }
        .a4-body {
            margin-top: 20px;
        }
        .a4-body-text {
            margin-top: 10px;
            text-indent: 40px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .a4-footer-block {
            margin-top: 40px;
        }
        .a4-footer-list {
            margin-top: 10px;
        }
        .a4-sign-row {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .a4-sign-col {
            width: 30%;
            text-align: center;
        }
        .a4-sign-line {
            border-bottom: 1px solid #000;
            min-height: 25px;
        }
        .a4-sign-hint {
            font-size: 9pt;
        }
    </style>
</head>
<body>

<div class="nav">
    <h2>‚öñÔ∏è –ö–ê–ù–¶–ï–õ–Ø–†–ò–Ø –°–£–î–ê</h2>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/logout">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <h3 style="margin-top:0">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>

        <div class="form-grid">
            <div>
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–¥:</label>
                <select id="f_court">
                    {% for c in court_options %}
                        <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>–¢–∏–ø –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞):</label>
                <select id="f_type">
                    <optgroup label="1. –°–µ–º–µ–π–Ω—ã–µ —Å–ø–æ—Ä—ã">
                        <option>–ò—Å–∫ –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –±—Ä–∞–∫–∞ (—Ä–∞–∑–≤–æ–¥)</option>
                        <option>–ò—Å–∫ –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –∞–ª–∏–º–µ–Ω—Ç–æ–≤</option>
                    </optgroup>
                    <optgroup label="2. –ñ–∏–ª–∏—â–Ω—ã–µ —Å–ø–æ—Ä—ã">
                        <option>–ò—Å–∫ –æ –≤—Å–µ–ª–µ–Ω–∏–∏</option>
                        <option>–ò—Å–∫ –æ –≤—ã—Å–µ–ª–µ–Ω–∏–∏</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="form-grid">
            <div>
                <label>–§–ò–û –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">

                <label>–ê–¥—Ä–µ—Å –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec_addr" placeholder="–£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å">

                <label>–¢–µ–ª–µ—Ñ–æ–Ω –ò—Å—Ç—Ü–∞:</label>
                <input type="text" id="f_istec_phone" placeholder="–£–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            </div>
            <div>
                <label>–§–ò–û –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">

                <label>–ê–¥—Ä–µ—Å –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet_addr" placeholder="–£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å">

                <label>–¢–µ–ª–µ—Ñ–æ–Ω –û—Ç–≤–µ—Ç—á–∏–∫–∞:</label>
                <input type="text" id="f_otvet_phone" placeholder="–£–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            </div>
        </div>

        <label>–°—É—Ç—å –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è:</label>
        <textarea id="f_text" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é..."></textarea>

        <label>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å—å (–§–∞–º–∏–ª–∏—è –ò.–û.):</label>
        <input type="text" id="f_sign" placeholder="–§–∞–º–∏–ª–∏—è –ò.–û.">

        <button class="btn-send" onclick="generateAndSend()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)</button>
    </div>

    <div id="casesList">
        <h3>üìÇ –î–µ–ª–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
        {% if cases %}
            {% for case in cases %}
                <div class="card">
                    <p>
                        <strong>–î–µ–ª–æ {{ case.case_num }}</strong>
                        <span class="badge badge-court">{{ case.court_type }}</span>
                        <span class="badge badge-new">{{ case.status }}</span><br>
                        <small>–î–∞—Ç–∞: {{ case.date.strftime('%d.%m.%Y %H:%M') }} UTC</small>
                    </p>
                    <img src="{{ case.image_data }}" class="case-image">
                </div>
            {% endfor %}
        {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–ª.</p>
        {% endif %}
    </div>
</div>

<!-- ==== –ù–û–í–´–ô –®–ê–ë–õ–û–ù A4 –ö–ê–ö –ù–ê –í–¢–û–†–û–ú –°–ö–†–ò–ù–ï ==== -->
<div id="paper-template">
    <!-- –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π –±–ª–æ–∫ -->
    <div class="a4-top">
        <div class="a4-top-right">
            <div style="text-align:right;">–í</div>
            <div class="a4-row">
                <span class="a4-court-line" id="p_court">–£–ö–ê–ó–ê–¢–¨ –°–ê–ú –°–£–î</span>
            </div>
            <div class="a4-row" style="font-size:10pt;">
                ( –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–µ–±–Ω–æ–π –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏ )
            </div>

            <div class="a4-row" style="margin-top:20px;">
                <span class="a4-label">–ò—Å—Ç–µ—Ü:</span>
                <span class="a4-underline" id="p_istec">–§–ê–ú–ò–õ–ò–Ø –ò–ú–Ø –û–¢–ß–ï–°–¢–í–û</span>
            </div>
            <div class="a4-row">
                <span class="a4-label">–ê–¥—Ä–µ—Å:</span>
                <span class="a4-underline" id="p_istec_addr">–£–ö–ê–ó–ê–¢–¨ –ê–î–†–ï–°</span>
            </div>
            <div class="a4-row">
                <span class="a4-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                <span class="a4-underline" id="p_istec_phone">–£–ö–ê–ó–ê–¢–¨ –ù–û–ú–ï–† –¢–ï–õ–ï–§–û–ù–ê</span>
            </div>

            <div class="a4-row" style="margin-top:20px;">
                <span class="a4-label">–û—Ç–≤–µ—Ç—á–∏–∫:</span>
                <span class="a4-underline" id="p_otvet">–§–ê–ú–ò–õ–ò–Ø –ò–ú–Ø –û–¢–ß–ï–°–¢–í–û</span>
            </div>
            <div class="a4-row">
                <span class="a4-label">–ê–¥—Ä–µ—Å:</span>
                <span class="a4-underline" id="p_otvet_addr">–£–ö–ê–ó–ê–¢–¨ –ê–î–†–ï–°</span>
            </div>
            <div class="a4-row">
                <span class="a4-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                <span class="a4-underline" id="p_otvet_phone">–£–ö–ê–ó–ê–¢–¨ –ù–û–ú–ï–† –¢–ï–õ–ï–§–û–ù–ê</span>
            </div>
        </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ" -->
    <div class="a4-title-block">
        <div class="a4-title-main">–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ</div>
        <div>–æ <span id="p_type">–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê</span></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å -->
    <div class="a4-body">
        <div>–°—É—Ç—å –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è.</div>
        <div class="a4-body-text" id="p_text"></div>
    </div>

    <!-- –ù–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="a4-footer-block">
        <div>
            –ù–∞ –∑–∞–∫–æ–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö, –∏–∑–ª–æ–∂–µ–Ω–Ω—ã—Ö –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–µ–π –∏ –∏–Ω—ã–º–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ‚Äë–ø—Ä–∞–≤–æ–≤—ã–º–∏ –∞–∫—Ç–∞–º–∏,
            –ø—Ä–æ—à—É –°—É–¥ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω–æ–µ –º–æ—ë –∏—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –∏ –ø—Ä–∏–Ω—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ä—ã –ø–æ
            –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –¥–∞–Ω–Ω–æ–º—É –¥–µ–ª—É.
        </div>

        <div class="a4-footer-list">
            <div>–ö –ò—Å–∫–æ–≤–æ–º—É –∑–∞—è–≤–ª–µ–Ω–∏—é –ø—Ä–∏–ª–∞–≥–∞—é:</div>
            <div>1. –ö–æ–ø–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫: –ø–∞—Å–ø–æ—Ä—Ç, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –ø–∞–∫–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π</div>
            <div>2. –ö–≤–∏—Ç–∞–Ω—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ –≥–æ—Å–ø–æ—à–ª–∏–Ω—ã, —Å–æ–≥–ª–∞—Å–Ω–æ –ó–∞–∫–æ–Ω—É ¬´–æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –ò—Å–∫–æ–≤—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π¬ª</div>
        </div>
    </div>

    <!-- –ü–æ–¥–ø–∏—Å–∏ –∏ –¥–∞—Ç–∞ -->
    <div class="a4-sign-row">
        <div class="a4-sign-col">
            <div class="a4-sign-line"></div>
            <div class="a4-sign-hint">( –ø–æ–¥–ø–∏—Å—å )</div>
        </div>
        <div class="a4-sign-col">
            <div class="a4-sign-line" id="p_sign"></div>
            <div class="a4-sign-hint">( —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ )</div>
        </div>
        <div style="width: 35%; text-align:right; font-size:11pt;">
            ¬´<span id="p_day">__</span>¬ª <span id="p_month">______________</span> 20__ –≥.
        </div>
    </div>
</div>

<script>
    // –°–≤—è–∑–∫–∞ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã —Å —à–∞–±–ª–æ–Ω–æ–º A4
    const bindings = [
        ['f_court', 'p_court'],
        ['f_istec', 'p_istec'],
        ['f_istec_addr', 'p_istec_addr'],
        ['f_istec_phone', 'p_istec_phone'],
        ['f_otvet', 'p_otvet'],
        ['f_otvet_addr', 'p_otvet_addr'],
        ['f_otvet_phone', 'p_otvet_phone'],
        ['f_type', 'p_type'],
        ['f_text', 'p_text'],
        ['f_sign', 'p_sign']
    ];

    bindings.forEach(([from, to]) => {
        const src = document.getElementById(from);
        const dst = document.getElementById(to);
        if (!src || !dst) return;

        // –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        dst.innerText = src.value;

        src.addEventListener('input', e => {
            dst.innerText = e.target.value;
        });
    });

    async function generateAndSend() {
        const btn = document.querySelector('.btn-send');
        btn.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG...";
        btn.disabled = true;

        const requiredIds = ['f_court','f_istec','f_otvet','f_text','f_sign'];
        for (const id of requiredIds) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
                return;
            }
        }

        const now = new Date();
        document.getElementById('p_day').innerText = now.getDate();
        const months = [
            "—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è",
            "–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"
        ];
        document.getElementById('p_month').innerText = months[now.getMonth()];

        const template = document.getElementById('paper-template');
        const canvas = await html2canvas(template, { scale: 2 });
        const imageData = canvas.toDataURL("image/png");

        const courtType = document.getElementById('f_court').value;

        try {
            const response = await fetch('/save_case_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageData,
                    court_type: courtType
                })
            });

            if (response.ok) {
                const res = await response.json();
                alert("–ò—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ù–æ–º–µ—Ä –¥–µ–ª–∞: " + res.case_num);
                location.reload();
            } else {
                console.error("SAVE ERROR:", await response.text());
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
            btn.disabled = false;
            btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
        }
    }
</script>
</body>
</html>
