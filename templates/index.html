<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—É–¥–µ–±–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- –†—É–∫–æ–ø–∏—Å–Ω—ã–π —à—Ä–∏—Ñ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—Ç–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #eef2f7;
            margin: 0;
            padding-bottom: 50px;
        }
        .nav {
            background: #1a237e;
            color: #fff;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #c5a059;
        }
        .nav a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
            margin-left: 15px;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.85em;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn-send {
            background: #c5a059;
            color: white;
            padding: 15px;
            border: none;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .btn-send:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .case-image {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 6px;
        }
        .badge-new { background: #e3f2fd; color: #1565c0; }
        .badge-court { background: #fff3cd; color: #856404; }

        /* === –û–ë–õ–ê–°–¢–¨ A4: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç === */
        #paper-template {
            width: 794px;   /* A4 –ø—Ä–∏ 96dpi */
            height: 1123px;
            background: #ffffff;
            position: absolute;
            left: -9999px;
            top: 0;
            overflow: hidden;
        }

        /* –†—É–∫–æ–ø–∏—Å–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Å—É—Ç–∏, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        #p_text {
            font-family: 'Patrick Hand', cursive !important;
            font-size: 13pt !important; /* –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ */
        }
    </style>
</head>
<body>

<div class="nav">
    <h2>‚öñÔ∏è –ö–ê–ù–¶–ï–õ–Ø–†–ò–Ø –°–£–î–ê</h2>
    <div>
        <strong>{{ user.username }}</strong> ({{ user.role }})
        <a href="/logout">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="container">
    <!-- –§–û–†–ú–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –ü–ï–†–ï–ú–ï–ù–ù–´–• -->
    <div class="card">
        <h3 style="margin-top:0">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>

        <div class="form-grid">
            <div>
                <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–∞:</label>
                <input type="text" id="f_court1" placeholder="–£–∫–∞–∑–∞—Ç—å —Å–∞–º —Å—É–¥">
            </div>
            <div>
                <label>–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê:</label>
                <input type="text" id="f_process" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –±—Ä–∞–∫–∞">
            </div>
        </div>

        <div class="form-grid">
            <div>
                <label>–ò—Å—Ç–µ—Ü ‚Äî –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ1:</label>
                <input type="text" id="f_fio1" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">
                <label>–ê–¥—Ä–µ—Å1:</label>
                <input type="text" id="f_addr1" placeholder="–ê–¥—Ä–µ—Å –∏—Å—Ç—Ü–∞">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω1:</label>
                <input type="text" id="f_tel1" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏—Å—Ç—Ü–∞">
            </div>
            <div>
                <label>–û—Ç–≤–µ—Ç—á–∏–∫ ‚Äî –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ2:</label>
                <input type="text" id="f_fio2" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ">
                <label>–ê–¥—Ä–µ—Å2:</label>
                <input type="text" id="f_addr2" placeholder="–ê–¥—Ä–µ—Å –æ—Ç–≤–µ—Ç—á–∏–∫–∞">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω2:</label>
                <input type="text" id="f_tel2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–≤–µ—Ç—á–∏–∫–∞">
            </div>
        </div>

        <label>–°—É—Ç—å –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è (–¥–æ 950 —Å–∏–º–≤–æ–ª–æ–≤):</label>
        <textarea id="f_text" rows="6" placeholder="–û–ø–∏—à–∏—Ç–µ —Å—É—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è..."></textarea>
        <div id="text-counter" style="font-size:0.8em;color:#666;margin-top:4px;">
            0 / 950 —Å–∏–º–≤–æ–ª–æ–≤
        </div>

        <button class="btn-send" onclick="generateAndSend()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)</button>
    </div>

    <!-- –°–ü–ò–°–û–ö –î–ï–õ -->
    <div class="card">
        <h3>üìÇ –î–µ–ª–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
        {% if cases %}
            {% for case in cases %}
                <div style="margin-bottom:20px;">
                    <p>
                        <strong>–î–µ–ª–æ {{ case.case_num }}</strong>
                        <span class="badge badge-court">{{ case.court_type }}</span>
                        <span class="badge badge-new">{{ case.status }}</span><br>
                        <small>–î–∞—Ç–∞: {{ case.date.strftime('%d.%m.%Y %H:%M') }} UTC</small>
                    </p>
                    <img src="{{ case.image_data }}" class="case-image">
                </div>
            {% endfor %}
        {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–ª.</p>
        {% endif %}
    </div>
</div>

<!-- ====== –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –î–û–ö–£–ú–ï–ù–¢ (–¢–í–û–ô HTML) ====== -->
<div id="paper-template">
    <!-- –í–µ—Å—å —Ç–≤–æ–π HTML, –ù–û —Å –∑–∞–º–µ–Ω–æ–π —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ span —Å ID -->
    <div class="c13 doc-content">
        <p class="c8"><span class="c17"></span></p>
        <p class="c8"><span class="c3"></span></p>

        <table class="c5">
            <tr class="c29">
                <td class="c14"><p class="c10"><span class="c3">–í</span></p></td>
                <td class="c0">
                    <p class="c24">
                        <span class="c3" id="p_court1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –°—É–¥–∞1</span>
                    </p>
                </td>
            </tr>
        </table>

        <p class="c21 c33">
            <span class="c34">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ( –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–µ–±–Ω–æ–π –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏ )</span>
        </p>

        <table class="c12">
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c3">–ò—Å—Ç–µ—Ü:</span></p></td>
                <td class="c11"><p class="c24">
                    <span class="c15" id="p_fio1">–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ1</span>
                </p></td>
            </tr>
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c25">–ê–¥—Ä–µ—Å:</span></p></td>
                <td class="c18"><p class="c24">
                    <span class="c17" id="p_addr1">–ê–¥—Ä–µ—Å1</span>
                </p></td>
            </tr>
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c25">–¢–µ–ª–µ—Ñ–æ–Ω:</span></p></td>
                <td class="c18"><p class="c24">
                    <span class="c17" id="p_tel1">–¢–µ–ª–µ—Ñ–æ–Ω1</span>
                </p></td>
            </tr>
        </table>

        <table class="c12">
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c3">–û—Ç–≤–µ—Ç—á–∏–∫:</span></p></td>
                <td class="c11"><p class="c24">
                    <span class="c15" id="p_fio2">–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ2</span>
                </p></td>
            </tr>
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c25">–ê–¥—Ä–µ—Å:</span></p></td>
                <td class="c18"><p class="c24">
                    <span class="c17" id="p_addr2">–ê–¥—Ä–µ—Å2</span>
                </p></td>
            </tr>
            <tr class="c22">
                <td class="c26"><p class="c10"><span class="c25">–¢–µ–ª–µ—Ñ–æ–Ω:</span></p></td>
                <td class="c18"><p class="c24">
                    <span class="c17" id="p_tel2">–¢–µ–ª–µ—Ñ–æ–Ω2</span>
                </p></td>
            </tr>
        </table>

        <p class="c16"><span class="c3">–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ</span></p>
        <p class="c16"><span class="c3">–æ <span id="p_process">–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê</span></span></p>

        <p class="c7"><span class="c32">–°—É—Ç—å –∏—Å–∫–æ–≤–æ–≥–æ –∑–∞—è–≤–ª–µ–Ω–∏—è.</span></p>
        <!-- –°–Æ–î–ê –ü–û–î–°–¢–ê–í–õ–Ø–ï–ú –°–£–¢–¨ (–†–£–ö–û–ü–ò–°–ù–´–ô –®–†–ò–§–¢) -->
        <p class="c7"><span class="c6" id="p_text"></span></p>

        <p class="c7">
            <span class="c6">
                –ù–∞ –∑–∞–∫–æ–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö, –∏–∑–ª–æ–∂–µ–Ω–Ω—ã—Ö –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–µ–π –∏ –∏–Ω—ã–º–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ‚Äë–ø—Ä–∞–≤–æ–≤—ã–º–∏ –∞–∫—Ç–∞–º–∏,
                –ø—Ä–æ—à—É –°—É–¥ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω–æ–µ –º–æ—ë –∏—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –∏ –ø—Ä–∏–Ω—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ä—ã –ø–æ
                –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –¥–∞–Ω–Ω–æ–º—É –¥–µ–ª—É.
            </span>
        </p>

        <p class="c7">
            <span class="c6">–ö –ò—Å–∫–æ–≤–æ–º—É –∑–∞—è–≤–ª–µ–Ω–∏—é –ø—Ä–∏–ª–∞–≥–∞—é:</span>
        </p>
        <p class="c7 c27">
            <span class="c6">
                1. –ö–æ–ø–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫: –ø–∞—Å–ø–æ—Ä—Ç, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –ø–∞–∫–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π
            </span>
        </p>
        <p class="c7 c27">
            <span class="c6">
                2. –ö–≤–∏—Ç–∞–Ω—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ –≥–æ—Å–ø–æ—à–ª–∏–Ω—ã, —Å–æ–≥–ª–∞—Å–Ω–æ –ó–∞–∫–æ–Ω—É ¬´–æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –ò—Å–∫–æ–≤—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π¬ª
            </span>
        </p>

        <!-- –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π –∏ –º–µ—Å—Ç–∞–º–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ ‚Äî –ë–ï–ó –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <p class="c7 c27">
            <span class="c6">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                ¬´___¬ª _______________ 20 __ –≥.
            </span>
        </p>

        <table class="c31">
            <tr class="c35">
                <td class="c20"><p class="c24"><span class="c6">( –ø–æ–¥–ø–∏—Å—å )</span></p></td>
                <td class="c30"></td>
                <td class="c1"><p class="c24"><span class="c6">( —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ )</span></p></td>
                <td class="c2"></td>
                <td class="c19"></td>
            </tr>
        </table>
    </div>
</div>

<script>
    // –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
    const bindings = [
        ['f_court1', 'p_court1'],
        ['f_fio1',   'p_fio1'],
        ['f_fio2',   'p_fio2'],
        ['f_addr1',  'p_addr1'],
        ['f_addr2',  'p_addr2'],
        ['f_tel1',   'p_tel1'],
        ['f_tel2',   'p_tel2'],
        ['f_process','p_process']
    ];

    bindings.forEach(([from, to]) => {
        const src = document.getElementById(from);
        const dst = document.getElementById(to);
        if (!src || !dst) return;
        dst.innerText = src.value;
        src.addEventListener('input', e => {
            dst.innerText = e.target.value;
        });
    });

    // –°—É—Ç—å –∏—Å–∫–∞: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 950 —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç
    const textArea = document.getElementById('f_text');
    const textDst  = document.getElementById('p_text');
    const counter  = document.getElementById('text-counter');
    const MAX_LEN = 950;

    textArea.addEventListener('input', e => {
        let val = e.target.value;
        if (val.length > MAX_LEN) {
            val = val.slice(0, MAX_LEN);
            e.target.value = val;
        }
        textDst.innerText = val;
        counter.textContent = `${val.length} / ${MAX_LEN} —Å–∏–º–≤–æ–ª–æ–≤`;
    });

    async function generateAndSend() {
        const btn = document.querySelector('.btn-send');
        btn.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG...";
        btn.disabled = true;

        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        const required = ['f_court1','f_fio1','f_fio2','f_text'];
        for (const id of required) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (—Å—É–¥, –§–ò–û –∏—Å—Ç—Ü–∞/–æ—Ç–≤–µ—Ç—á–∏–∫–∞, —Å—É—Ç—å).");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
                return;
            }
        }

        const template = document.getElementById('paper-template');
        const canvas = await html2canvas(template, { scale: 2 });
        const imageData = canvas.toDataURL("image/png");

        // –î–ª—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–µ–ª–∞ –ø–æ–ª—å–∑—É–µ–º—Å—è —Ç–∏–ø–æ–º —Å—É–¥–∞ –∏–∑ —Ñ–æ—Ä–º—ã (—Ç–æ, —á—Ç–æ —Ä–∞–Ω—å—à–µ court_type)
        const courtType = document.getElementById('f_court1').value || "–í–µ—Ä—Ö–æ–≤–Ω—ã–π —Å—É–¥";

        try {
            const response = await fetch('/save_case_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageData,
                    court_type: courtType
                })
            });

            if (response.ok) {
                const res = await response.json();
                alert("–ò—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ù–æ–º–µ—Ä –¥–µ–ª–∞: " + res.case_num);
                location.reload();
            } else {
                console.error("SAVE ERROR:", await response.text());
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
                btn.disabled = false;
                btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
            btn.disabled = false;
            btn.innerText = "–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨ –ò–°–ö (PNG)";
        }
    }
</script>
</body>
</html>
